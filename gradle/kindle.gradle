import org.gradle.internal.os.OperatingSystem

def kindlegenDir = "${System.properties['user.home']}${File.separator}.kindlegen"
def kindlegenHome = "${kindlegenDir}${File.separator}bin"

task downloadKindlegen(type: Download) {
  def kindleGenLinux = "http://kindlegen.s3.amazonaws.com/kindlegen_linux_2.6_i386_v2_9.tar.gz";
  def kindleGenWin = "http://kindlegen.s3.amazonaws.com/kindlegen_win32_v2_9.zip";
  def kindleGenMac = "https://kindlegen.s3.amazonaws.com/KindleGen_Mac_i386_v2_9.zip";
  def kindleGen = kindleGenLinux;
  OperatingSystem operatingSystem = OperatingSystem.current();
  if(operatingSystem.isWindows()){
    kindleGen = kindleGenWin
  }else if(operatingSystem.isMacOsX()){
    kindleGen = kindleGenMac;
  }
  def subffix = kindleGen.substring(kindleGen.lastIndexOf("."));
  ext.output = file("$kindlegenDir/cache/kindlegen" + subffix)
  println "start download file to ${ext.output}"
  src kindleGen
  dest output
  overwrite false
  onlyIfModified true
}

task extractKindlegen() {
  dependsOn downloadKindlegen
  println "file:${downloadKindlegen.output}"
  def executeFile = file("${kindlegenHome}${File.separator}kindlegen");
  OperatingSystem operatingSystem = OperatingSystem.current();
  if(operatingSystem.isWindows()){
    executeFile = file("${kindlegenDir}${File.separator}kindlegen.exe");
  }
  if(!executeFile.exists()){
    println "start extra file..."
    copy{
      from {
        if (downloadKindlegen.output.name.endsWith('.zip')) {
          zipTree(downloadKindlegen.output)
        }
        else {
          tarTree(downloadKindlegen.output)
        }
      }
      into "$kindlegenHome"
    }

  }

}

task setenv(type: Exec) {
  environment 'KINDLEGEN',"${kindlegenHome}"
  //  commandLine "export", "KINDLEGEN=$kindlegenDir"
  commandLine "echo", "set env"
}

task kindlegen{
  doLast {
    def kindleHome = System.getenv("KINDLEGEN")
    if(kindleHome==null||kindleHome.trim().length()==0){
      extractKindlegen.execute()
      setenv.mustRunAfter extractKindlegen
      setenv.execute()

    }else{
      println "use kindlegen in ${kindleHome}"
    }
  }
}